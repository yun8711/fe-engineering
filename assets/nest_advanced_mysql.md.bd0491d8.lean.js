import{_ as s,v as n,b as a,R as l}from"./chunks/framework.8277b2e6.js";const p="/fe-engineering/assets/typeorm_1.5c1638f1.png",E=JSON.parse('{"title":"集成数据库","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"nest/advanced/mysql.md","filePath":"nest/advanced/mysql.md","lastUpdated":1710175002000}'),o={name:"nest/advanced/mysql.md"},e=l('<h1 id="集成数据库" tabindex="-1">集成数据库 <a class="header-anchor" href="#集成数据库" aria-label="Permalink to &quot;集成数据库&quot;">​</a></h1><p>Nest 本身与数据库无关，可以与任何 SQL 或 NOSQL 数据库集成。一般来说只需要为数据库加载一个适当的 nodejs 驱动程序。</p><p>也可以直接使用任何通用的数据库集成库或 ORM，比如 <a href="https://www.npmjs.com/package/sequelize" target="_blank" rel="noreferrer">Sequelize (recipe)</a>、<a href="http://knexjs.org/" target="_blank" rel="noreferrer">knexjs</a> (tutorial)`、 <a href="https://github.com/typeorm/typeorm" target="_blank" rel="noreferrer">TypeORM</a> ，以在更高的抽象级别上进行操作</p><p><code>Nest</code> 提供了与现成的 <code>TypeORM</code> 与 <code>@nestjs/typeorm</code> 的紧密集成，</p><h2 id="typeorm-流程" tabindex="-1">TypeORM 流程 <a class="header-anchor" href="#typeorm-流程" aria-label="Permalink to &quot;TypeORM 流程&quot;">​</a></h2><p><img src="'+p+`" alt="nest_typeorm_01"></p><p>DataSource 里存放着数据库连接的配置，比如用户名、密码、驱动包、连接池配置等等</p><p>而 Entity 里通过 @Entity、@PrimaryGeneratedColumn、@Column 等装饰器来建立数据库表的映射关系。</p><p>同时还有 Entity 之间的 @OneToOne、@OneToMany、@ManyToMany 的关系，这些会映射成数据库表通过外键、中间表来建立的关系。</p><p>DataSource.initialize 的时候，会和数据库服务建立连接，如果配置了 synchronize，还会生成建表 sql 语句来创建表。</p><p>DataSource 初始化之后就可以拿到 EntityManager 了，由它负责对各种 Entity 进行增删改查，比如 find、delete、save 等方法，还可以通过 query builder 来创建复杂的查询。</p><p>如果你只是想做对单个 Entity 的 CRUD，那可以拿到这个 Entity 的 Repository 类，它同样有上面的那些方法，只是只能用来操作单个 Entity。</p><h2 id="typeorm-集成" tabindex="-1">TypeORM 集成 <a class="header-anchor" href="#typeorm-集成" aria-label="Permalink to &quot;TypeORM 集成&quot;">​</a></h2><p><a href="https://github.com/typeorm/typeorm" target="_blank" rel="noreferrer">TypeORM</a> 是 <code>TypeScript</code> 中最成熟的对象关系映射器( <code>ORM</code> )，可以很好地与 <code>Nest</code> 框架集成。</p><p><code>TypeORM</code> 支持许多关系数据库，比如 <code>PostgreSQL</code> 、<code>Oracle</code>、<code>Microsoft SQL Server</code>、<code>SQLite</code>，以及像 <code>MongoDB</code> 这样的 <code>NoSQL</code> 数据库</p><h3 id="集成-mysql" tabindex="-1">集成 Mysql <a class="header-anchor" href="#集成-mysql" aria-label="Permalink to &quot;集成 Mysql&quot;">​</a></h3><p>安装依赖</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">add</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">@nestjs/typeorm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">typeorm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">mysql2</span></span></code></pre></div><p>将 <code>TypeOrmModule</code> 导入<code>AppModule</code></p><div class="language-typescript"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// app.module.ts</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Module</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@nestjs/common</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">TypeOrmModule</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@nestjs/typeorm</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">Module</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">imports</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 全局配置</span></span>
<span class="line"><span style="color:#BABED8;">     ConfigModule</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forRoot</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">isGlobal</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">envFilePath</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">src/.env</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">    TypeOrmModule</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">forRootAsync</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">inject</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [ConfigService]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#F07178;">useFactory</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">configService</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">ConfigService</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">          type</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">mysql</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          host</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">configService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">MYSQL_HOST</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          port</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">configService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">MYSQL_PORT</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          username</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">configService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">MYSQL_USERNAME</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          password</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">configService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">MYSQL_PASSWORD</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">          database</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">configService</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">MYSQL_DATABASE</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 是否自动创建数据库表结构</span></span>
<span class="line"><span style="color:#F07178;">          synchronize</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 打印日志级别</span></span>
<span class="line"><span style="color:#F07178;">          logging</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> [</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">warn</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 线程池大小</span></span>
<span class="line"><span style="color:#F07178;">          poolSize</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">10</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 数据库连接驱动程序</span></span>
<span class="line"><span style="color:#F07178;">          connectorPackage</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">mysql2</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 自动加载实体类</span></span>
<span class="line"><span style="color:#F07178;">          autoLoadEntities</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#BABED8;">  ]</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">export</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">AppModule</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{}</span></span></code></pre></div><p><code>forRoot()</code> 方法支持所有<code>TypeORM</code>包中<code>createConnection()</code>函数暴露出的配置属性，详见：[附录：typeorm 配置项](./附录：typeorm 配置项.md)</p><p>connectorPackage：指定用于连接到MySQL数据库的驱动程序，可以是 mysql 或 mysql2</p><p>mysql和mysql2都是Node.js的MySQL客户端，在许多方面都很相似，mysql2完全兼容mysql，并且在大多数情况下可以作为替代品使用，但它们之间存在一些差异：</p><ul><li>mysql2还提供了一些额外的功能，如支持Promise，更好的性能，以及更全面的协议支持</li><li>mysql2在处理大型查询结果集时，性能更优，因为它使用了更快的原生解析器</li><li>mysql2还支持预处理语句和服务器端预处理语句，这可以提供更好的安全性和性能。</li></ul><p>entities 用来指定有哪些和数据库对应的 Entity，有两种方式：</p><ul><li>一是使用 class</li><li>另一种是<code>[__dirname + &#39;/**/*.entity{.ts,.js}&#39;]</code></li></ul><p>其他额外的配置参数描述如下：</p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">retryAttempts</td><td style="text-align:left;">重试连接数据库的次数（默认：10）</td></tr><tr><td style="text-align:left;">retryDelay</td><td style="text-align:left;">两次重试连接的间隔(ms)（默认：3000）</td></tr><tr><td style="text-align:left;">autoLoadEntities</td><td style="text-align:left;">如果为<code>true</code>,将自动加载实体(默认：false)</td></tr></tbody></table><p>创建数据库</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">DATABASE</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">yun_admin</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">DEFAULT</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">CHARACTER</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">SET</span><span style="color:#BABED8;"> utf8mb4;</span></span></code></pre></div>`,30),t=[e];function c(r,y,F,D,i,d){return n(),a("div",null,t)}const A=s(o,[["render",c]]);export{E as __pageData,A as default};
